name: Build and Release

on:
  push:
    branches:
      - master
    tags:
      - "v*"

permissions:
  contents: write

env:
  # 控制 Rust 构建工具 Cargo 的输出颜色
  CARGO_TERM_COLOR: always
  # 编译平台
  PLATFORM_EXTS: |
    src-tauri/target/release/bundle/**/*.dmg
    src-tauri/target/release/bundle/**/*.msi
    src-tauri/target/release/bundle/**/*.deb
    src-tauri/target/release/bundle/**/*.rpm

jobs:
  build:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: macos
          - os: ubuntu-22.04
            platform: linux
          - os: windows-latest
            platform: windows

    steps:
      - uses: actions/checkout@v4

      # =============================
      # Node
      # =============================
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # =============================
      # Rust
      # =============================
      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Detect latest FFmpeg version
        id: ffmpeg
        shell: bash
        run: |
          set -euo pipefail

          LATEST=$(
            curl -s https://ffmpeg.org/releases/ \
            | sed -nE 's/.*ffmpeg-([0-9]+\.[0-9]+(\.[0-9]+)?)\.tar\.xz.*/\1/p' \
            | sort -V \
            | tail -1
          )

          echo "FFMPEG_VERSION=$LATEST" >> "$GITHUB_ENV"

      # ===============================
      # macOS – dependencies
      # ===============================
      - name: Install dependencies (macOS)
        if: matrix.platform == 'macos'
        run: |
          brew install pkg-config nasm yasm

          curl -LO https://ffmpeg.org/releases/ffmpeg-$FFMPEG_VERSION.tar.xz
          tar -xf ffmpeg-$FFMPEG_VERSION.tar.xz
          mv ffmpeg-$FFMPEG_VERSION ffmpeg
          cd ffmpeg
          ./configure \
            --prefix=$HOME/ffmpeg \
            --enable-shared \
            --disable-static \
            --enable-pthreads \
            --enable-version3
          make -j$(sysctl -n hw.ncpu)
          make install

          echo "PKG_CONFIG_PATH=$HOME/ffmpeg/lib/pkgconfig" >> $GITHUB_ENV
          echo "CPATH=$HOME/ffmpeg/include" >> $GITHUB_ENV
          echo "LIBRARY_PATH=$HOME/ffmpeg/lib" >> $GITHUB_ENV
          echo "PATH=$HOME/ffmpeg/bin:$PATH" >> $GITHUB_ENV

      # ===============================
      # Linux – dependencies
      # ===============================
      - name: Install dependencies (Linux)
        if: matrix.platform == 'linux'
        run: |
          sudo apt-get update -y
          sudo apt-get upgrade -y
          DEBIAN_FRONTEND=noninteractive sudo apt-get install -y \
            pkg-config \
            nasm \
            yasm \
            build-essential \
            file \
            xz-utils \
            gzip \
            libgtk-3-dev \
            libglib2.0-dev \
            libwebkit2gtk-4.1-dev \
            libsoup-3.0-dev \
            libappindicator3-dev \
            librsvg2-dev \
            libasound2-dev \
            libunwind-dev \
            gstreamer1.0-plugins-base \
            gstreamer1.0-plugins-good \
            gstreamer1.0-libav

          curl -LO https://ffmpeg.org/releases/ffmpeg-$FFMPEG_VERSION.tar.xz
          tar -xf ffmpeg-$FFMPEG_VERSION.tar.xz
          mv ffmpeg-$FFMPEG_VERSION ffmpeg
          cd ffmpeg
          ./configure \
            --prefix=$HOME/ffmpeg \
            --enable-shared \
            --disable-static \
            --enable-pthreads \
            --enable-version3
          make -j$(nproc)
          make install

          echo "PKG_CONFIG_PATH=$HOME/ffmpeg/lib/pkgconfig" >> $GITHUB_ENV
          echo "CPATH=$HOME/ffmpeg/include" >> $GITHUB_ENV
          echo "LIBRARY_PATH=$HOME/ffmpeg/lib" >> $GITHUB_ENV
          echo "PATH=$HOME/ffmpeg/bin:$PATH" >> $GITHUB_ENV

      # ===============================
      # Windows – dependencies
      # ===============================
      - name: Install dependencies (Windows)
        if: matrix.platform == 'windows'
        shell: bash
        run: |

          if [ ! -d /c/vcpkg ]; then
            git clone https://github.com/microsoft/vcpkg.git /c/vcpkg
          fi

          /c/vcpkg/bootstrap-vcpkg.bat
          /c/vcpkg/vcpkg install ffmpeg --triplet x64-windows-static-md

          echo "VCPKG_ROOT=C:\vcpkg" >> $GITHUB_ENV
          echo "VCPKG_DEFAULT_TRIPLET=x64-windows-static-md" >> $GITHUB_ENV

      # =============================
      # Set app version
      # =============================
      - name: set app version
        if: startsWith(github.ref, 'refs/tags/')
        shell: bash
        run: |
          APP_VERSION=${GITHUB_REF_NAME#v}

          npm version $APP_VERSION --no-git-tag-version

          jq --arg v "$APP_VERSION" '.version=$v' \
            src-tauri/tauri.conf.json > src-tauri/tauri.conf.json.tmp
          mv src-tauri/tauri.conf.json.tmp src-tauri/tauri.conf.json
          sed -i.bak "s/^version = \".*\"/version = \"$APP_VERSION\"/" src-tauri/Cargo.toml

      # =============================
      # Build Tauri
      # =============================
      - name: Build Tauri app
        run: |
          npm install
          npm run tauri build

      # =============================
      # Rename artifacts
      # =============================
      - name: Add platform suffix to all files
        shell: bash
        run: |
          shopt -s globstar || true
          for pattern in $PLATFORM_EXTS; do
            for f in $pattern; do
              [ -f "$f" ] || continue
              base="${f%.*}"
              ext="${f##*.}"
              mv "$f" "${base}-${{ matrix.platform }}.$ext"
            done
          done

      # =============================
      # Upload artifacts
      # =============================
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: tauri-${{ matrix.platform }}
          path: ${{ env.PLATFORM_EXTS }}
          if-no-files-found: error

  # ===================================
  # Release job
  # ===================================
  release:
    needs: build
    name: Create Release
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    steps:
      # ===================================
      # 检查对应 commit 的 build workflow 是否成功
      # ===================================
      # - uses: actions/github-script@v6
      #   id: check_build
      #   with:
      #     script: |
      #       const owner = context.repo.owner;
      #       const repo = context.repo.repo;

      #       // 获取 build workflow 的运行记录
      #       const workflows = await github.rest.actions.listWorkflowRuns({
      #         owner,
      #         repo,
      #         workflow_id: "build.yml",    // build workflow 文件名或者 name
      #         per_page: 50
      #       });

      #       // 找到当前 tag 指向的 commit
      #       console.log("The commit SHA is: " + context.sha)
      #       const run = workflows.data.workflow_runs.find(r => r.head_sha === context.sha);

      #       if (!run) {
      #         core.setFailed("No build workflow found for this commit. Release skipped.");
      #       } else if (run.conclusion !== "success") {
      #         core.setFailed(`Build workflow for this commit did not succeed: ${run.conclusion}`);
      #       } else {
      #         core.info("Build workflow succeeded. Proceeding with release.");
      #       }

      - uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: my-music ${{ github.ref_name }}
          body: |
            ${{ github.ref_name }} is out!!!
            - 支持 Windows / macOS / Linux
          files: |
            artifacts/**/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
